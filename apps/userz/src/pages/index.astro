---
import chunk from "lodash/chunk";
import Layout from "../components/Layout.astro";
import { daysarr } from "../lib/days";
import { l2Distance,cosineDistance,maxInnerProduct } from 'pgvector/drizzle-orm';
import { gquery,db,eq,q_a,questions,or} from "../lib/graph";
 
type Data = { genid: string; text: string }[];
const currentDate = new Date();
const dayOfYear: number = Math.floor(
  (currentDate.getTime() -
    new Date(currentDate.getFullYear(), 0, 0).getTime()) /
    86400000 +
    1
);
const genid = daysarr[dayOfYear];
const getEmbed = await  db.select({embed:q_a.embed})
  .from(q_a)
  .where(eq(q_a.genid,genid))
  .limit(1);
const   simOne =  await db.select({genid:q_a.genid,text:q_a.text})
.from(q_a)
.orderBy(l2Distance(q_a.embed, getEmbed[0].embed)).limit(30);
//  const simOneArr = or(simOne.map(x => eq(questions.genid, x.genid)))
//  console.log(simOneArr);
// const data1 = await db.select({genid:questions.genid}).from(questions).where(
//   
//   simOneArr
//   
// );
//  
//  console.log(data1);
 
 //const sessionId = Astro.cookies.get('session')
//const { session, user } = await lucia.validateSession(sessionId.value);
 
 
 

 

const data = await gquery(
  `query MyQuery( $_in: [String!])  {
	  questions1: q_q(where: {genid: {_in: $_in}}) {
		text
		genid
	  }
    answers: q_a(where: {genid: {_in: $_in}}) {
		text
		genid
	  }
	  q_qtags(order_by: {count: desc}, limit: 40) {
		  count
		  hashtag
		}
	}`,
  { _in: simOne.map(({ genid }: { genid: string }) => genid) }
);

const { questions1, answers } = data;
const chunks = chunk(questions1, 10) as Data[];
const chunksa = chunk(answers, 10) as Data[];
---

<Layout title="userz dot net." tags={data.qtags}>  
  <div class="max-w-screen-xl px-4 py-3 mx-auto">  

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3">
      {
        chunks.map((chunk, i) => (
          <div>
            {chunk.map(({ genid, text }, i1) => (
              <div class="grid">
                <a
                  href={"/" + genid}
                  class="p-6  m-3 border-emerald-600 border-4 rounded-lg shadow hover:bg-gray-800 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700 relative"
                >
                  <div class="absolute -top-1 -right-0.5 bg-emerald-600 px-2 rounded-bl-md  rounded-tr-lg text-xs text-black">
                    {new Date().toISOString().split("T")[0]}
                  </div>
                  <h5 class="mb-2 text-xl xs:text-2xl sm:text-3xl font-bold tracking-tight text-gray-200">
                    {" "}
                    {text.replaceAll("?", " ")}
                  </h5>
                  {chunksa[i][i1]?.text.slice(0, 150)} ...
                </a>
              </div>
            ))}
          </div>
        ))
      }
    </div>
  </div>
</Layout>
